!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("factor-utils"),require("@angular/core"),require("@angular/router")):"function"==typeof define&&define.amd?define("factor-auth",["exports","@angular/common/http","rxjs","rxjs/operators","factor-utils","@angular/core","@angular/router"],t):t(e["factor-auth"]={},e.ng.common.http,e.rxjs,e.rxjs.operators,e.i2,e.ng.core,e.ng.router)}(this,function(e,n,i,c,t,r,o){"use strict";var a=(s.prototype.addAuthenticationToken=function(e){var t=this.getToken();return!t||e.url.includes("token")?e:e.clone({setHeaders:{Authorization:"Bearer "+t}})},s.prototype.checkLoggedIn=function(){return this.getToken()?this.loggedInSource.next(!0):this.loggedInSource.next(!1),this.loggedIn},s.prototype.getToken=function(){return this.storageService.get(this.tokenKey,"local")},s.prototype.login=function(e){var t=this;return this.http.post(this.configuration.tokenUrl,e).pipe(c.tap(function(e){t.storageService.set(t.tokenKey,e.token,"local"),t.loggedInSource.next(!0)}))},s.prototype.logout=function(){this.storageService["delete"](this.tokenKey,"local"),this.loggedInSource.next(!1),this.configuration.nosessionUrl&&this.injector.get(o.Router).navigateByUrl(this.configuration.nosessionUrl)},s.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],s.ctorParameters=function(){return[{type:n.HttpClient},{type:t.StorageService},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]},{type:r.Injector}]},s.ngInjectableDef=r.defineInjectable({factory:function(){return new s(r.inject(n.HttpClient),r.inject(t.StorageService),r.inject("FactorAuthConfiguration"),r.inject(r.INJECTOR))},token:s,providedIn:"root"}),s);function s(e,t,r,o){this.http=e,this.storageService=t,this.configuration=r,this.injector=o,this.loggedInSource=new i.BehaviorSubject(!1),this.loggedIn=this.loggedInSource.asObservable(),this.tokenKey="auth_jwt",this.checkLoggedIn()}var u=(h.prototype.addAuthenticationToken=function(e){var t=this.getToken();return!t||e.url.includes("token")?e:e.clone({setHeaders:{Authorization:t.token_type+" "+t.access_token}})},h.prototype.checkLoggedIn=function(){return this.getToken()?this.loggedInSource.next(!0):this.loggedInSource.next(!1),this.loggedIn},h.prototype.getToken=function(){return this.storageService.get("token","local")},h.prototype.handle401Error=function(t,r){var o=this;return this.refreshTokenInProgress?this.refreshTokenSubject.pipe(c.filter(function(e){return null!=e}),c.take(1),c.switchMap(function(e){return r.handle(o.addAuthenticationToken(t))})):(this.refreshTokenInProgress=!0,this.refreshTokenSubject.next(null),this.refreshToken().pipe(c.switchMap(function(e){return e?(o.refreshTokenSubject.next(e),r.handle(o.addAuthenticationToken(t))):(o.logout(),i.throwError(""))}),c.catchError(function(e){return o.logout(),i.throwError(e)}),c.share(),c.finalize(function(){o.refreshTokenInProgress=!1})))},h.prototype.login=function(e){var t=this,r={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"password",response_type:"token",username:e.username,password:e.password,state:Date.now()};return this.http.post(this.configuration.tokenUrl,r).pipe(c.tap(function(e){t.storageService.set("token",e,"local"),t.loggedInSource.next(!0)}))},h.prototype.logout=function(){this.storageService["delete"]("token","local"),this.loggedInSource.next(!1),this.configuration.nosessionUrl&&this.injector.get(o.Router).navigateByUrl(this.configuration.nosessionUrl)},h.prototype.refreshToken=function(){var t=this,e=this.getToken(),r=""+this.configuration.tokenUrl,o={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"refresh_token",refresh_token:e.refresh_token};return this.http.get(r,{params:o}).pipe(c.tap(function(e){t.storageService.set("token",e,"local"),t.loggedInSource.next(!0)}))},h.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],h.ctorParameters=function(){return[{type:n.HttpClient},{type:t.StorageService},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]},{type:r.Injector}]},h.ngInjectableDef=r.defineInjectable({factory:function(){return new h(r.inject(n.HttpClient),r.inject(t.StorageService),r.inject("FactorAuthConfiguration"),r.inject(r.INJECTOR))},token:h,providedIn:"root"}),h);function h(e,t,r,o){this.http=e,this.storageService=t,this.configuration=r,this.injector=o,this.loggedInSource=new i.BehaviorSubject(!1),this.loggedIn=this.loggedInSource.asObservable(),this.refreshTokenInProgress=!1,this.refreshTokenSubject=new i.BehaviorSubject(null),this.checkLoggedIn()}var g=(p.prototype.getProvider=function(){return"oauth"===this.configuration.type?this.oauthService:this.jwtService},p.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],p.ctorParameters=function(){return[{type:n.HttpClient},{type:t.StorageService},{type:a},{type:u},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]}]},p.ngInjectableDef=r.defineInjectable({factory:function(){return new p(r.inject(n.HttpClient),r.inject(t.StorageService),r.inject(a),r.inject(u),r.inject("FactorAuthConfiguration"))},token:p,providedIn:"root"}),p);function p(e,t,r,o,n){this.http=e,this.storageService=t,this.jwtService=r,this.oauthService=o,this.configuration=n,this.getProvider().checkLoggedIn()}var f=(d.prototype.intercept=function(t,r){var o=this;return this.authService=this.injector.get(g),r.handle(this.authService.getProvider().addAuthenticationToken(t)).pipe(c.catchError(function(e){if(!(e instanceof n.HttpErrorResponse))return i.throwError(e);switch(e.status){case 401:return"undefined"!==o.authService.getProvider().handle401Error?o.authService.getProvider().handle401Error(t,r):(o.authService.getProvider().logout(),i.throwError(e));default:return i.throwError(e)}}))},d.decorators=[{type:r.Injectable}],d.ctorParameters=function(){return[{type:r.Injector},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]}]},d);function d(e,t){this.injector=e,this.configuration=t,this.refreshTokenInProgress=!1,this.refreshTokenSubject=new i.BehaviorSubject(null)}var l=(v.forRoot=function(e){return{ngModule:v,providers:[{provide:n.HTTP_INTERCEPTORS,useClass:f,multi:!0},{provide:"FactorAuthConfiguration",useValue:e}]}},v.decorators=[{type:r.NgModule,args:[{declarations:[],imports:[],exports:[]}]}],v);function v(){}var y=(j.prototype.canActivate=function(e,t){return!!this.authService.getProvider().getToken()||(this.authService.getProvider().logout(),!1)},j.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],j.ctorParameters=function(){return[{type:g},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]}]},j.ngInjectableDef=r.defineInjectable({factory:function(){return new j(r.inject(g),r.inject("FactorAuthConfiguration"))},token:j,providedIn:"root"}),j);function j(e,t){this.authService=e,this.configuration=t}var I=(S.prototype.canActivate=function(e,t){return!this.authService.getProvider().getToken()||(this.router.navigateByUrl("/"),!1)},S.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],S.ctorParameters=function(){return[{type:g},{type:o.Router},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]}]},S.ngInjectableDef=r.defineInjectable({factory:function(){return new S(r.inject(g),r.inject(o.Router),r.inject("FactorAuthConfiguration"))},token:S,providedIn:"root"}),S);function S(e,t,r){this.authService=e,this.router=t,this.configuration=r}e.AuthModule=l,e.AuthGuard=y,e.AuthService=g,e.LoginGuard=I,e.ɵa=f,e.ɵb=a,e.ɵc=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=factor-auth.umd.min.js.map