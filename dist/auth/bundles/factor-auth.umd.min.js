!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("factor-utils"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("@angular/core"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("factor-auth",["exports","factor-utils","@angular/router","rxjs","rxjs/operators","@angular/core","@angular/common/http"],t):t(e["factor-auth"]={},e.i2,e.ng.router,e.rxjs,e.rxjs.operators,e.ng.core,e.ng.common.http)}(this,function(e,t,r,n,i,o,c){"use strict";var a=(u.prototype.checkLoggedIn=function(){return this.storageService.get("token","local")?this.loggedInSource.next(!0):this.loggedInSource.next(!1),this.loggedIn},u.prototype.getToken=function(){return this.storageService.get("token","local")},u.prototype.login=function(e){var t=this,r={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"password",response_type:"token",username:e.username,password:e.password,state:Date.now()};return this.http.post(this.configuration.tokenUrl,r).pipe(i.tap(function(e){t.storageService.set("token",e,"local"),t.loggedInSource.next(!0)}))},u.prototype.logout=function(){this.storageService["delete"]("token","local"),this.loggedInSource.next(!1)},u.prototype.refreshToken=function(){var t=this,e=this.storageService.get("token","local"),r=""+this.configuration.tokenUrl,o={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"refresh_token",refresh_token:e.refresh_token};return this.http.get(r,{params:o}).pipe(i.tap(function(e){t.storageService.set("token",e,"local")}))},u.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],u.ctorParameters=function(){return[{type:c.HttpClient},{type:t.StorageService},{type:undefined,decorators:[{type:o.Inject,args:["FactorAuthConfiguration"]}]}]},u.ngInjectableDef=o.defineInjectable({factory:function(){return new u(o.inject(c.HttpClient),o.inject(t.StorageService),o.inject("FactorAuthConfiguration"))},token:u,providedIn:"root"}),u);function u(e,t,r){this.http=e,this.storageService=t,this.configuration=r,this.loggedInSource=new n.BehaviorSubject(!1),this.loggedIn=this.loggedInSource.asObservable(),this.getToken()&&this.getToken().access_token&&this.loggedInSource.next(!0)}var s=(h.prototype.canActivate=function(e,t){return!!this.authService.getToken()||(this.authService.logout(),!1)},h.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],h.ctorParameters=function(){return[{type:a}]},h.ngInjectableDef=o.defineInjectable({factory:function(){return new h(o.inject(a))},token:h,providedIn:"root"}),h);function h(e){this.authService=e}var p=(f.prototype.canActivate=function(e,t){return!this.authService.getToken()||(this.router.navigateByUrl("/"),!1)},f.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],f.ctorParameters=function(){return[{type:a},{type:r.Router}]},f.ngInjectableDef=o.defineInjectable({factory:function(){return new f(o.inject(a),o.inject(r.Router))},token:f,providedIn:"root"}),f);function f(e,t){this.authService=e,this.router=t}var l=(g.prototype.intercept=function(t,r){var o=this;return this.authService=this.injector.get(a),r.handle(this.addAuthenticationToken(t)).pipe(i.catchError(function(e){if(!(e instanceof c.HttpErrorResponse))return n.throwError(e);switch(e.status){case 401:return o.authService.getToken().refresh_token?o.handle401Error(t,r):n.throwError(e);default:return n.throwError(e)}}))},g.prototype.handle401Error=function(t,r){var o=this;return this.refreshTokenInProgress?this.refreshTokenSubject.pipe(i.filter(function(e){return null!=e}),i.take(1),i.switchMap(function(e){return r.handle(o.addAuthenticationToken(t))})):(this.refreshTokenInProgress=!0,this.refreshTokenSubject.next(null),this.authService.refreshToken().pipe(i.switchMap(function(e){return e?(o.refreshTokenSubject.next(e),r.handle(o.addAuthenticationToken(t))):(o.authService.logout(),n.throwError(""))}),i.catchError(function(e){return o.authService.logout(),n.throwError(e)}),i.share(),i.finalize(function(){o.refreshTokenInProgress=!1})))},g.prototype.addAuthenticationToken=function(e){var t=this.authService.getToken();return!t||e.url.includes("token")?e:e.clone({setHeaders:{Authorization:t.token_type+" "+t.access_token}})},g.decorators=[{type:o.Injectable}],g.ctorParameters=function(){return[{type:o.Injector}]},g);function g(e){this.injector=e,this.refreshTokenInProgress=!1,this.refreshTokenSubject=new n.BehaviorSubject(null)}var d=(v.forRoot=function(e){return{ngModule:v,providers:[{provide:c.HTTP_INTERCEPTORS,useClass:l,multi:!0},{provide:"FactorAuthConfiguration",useValue:e}]}},v.decorators=[{type:o.NgModule,args:[{declarations:[],imports:[],exports:[]}]}],v);function v(){}e.AuthService=a,e.AuthGuard=s,e.LoginGuard=p,e.AuthInterceptor=l,e.AuthModule=d,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=factor-auth.umd.min.js.map