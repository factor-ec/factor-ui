!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("factor-utils"),require("@angular/router")):"function"==typeof define&&define.amd?define("factor-auth",["exports","@angular/core","@angular/common/http","rxjs","rxjs/operators","factor-utils","@angular/router"],e):e((t=t||self)["factor-auth"]={},t.ng.core,t.ng.common.http,t.rxjs,t.rxjs.operators,t["factor-utils"],t.ng.router)}(this,(function(t,e,r,o,n,i,c){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function u(t,e,r,o){var n,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,o);else for(var u=t.length-1;u>=0;u--)(n=t[u])&&(c=(i<3?n(c):i>3?n(e,r,c):n(e,r))||c);return i>3&&c&&Object.defineProperty(e,r,c),c}function a(t,e){return function(r,o){e(r,o,t)}}var s=function(){function t(t,e,r,n){this.http=t,this.storageService=e,this.configuration=r,this.injector=n,this.loggedInSource=new o.BehaviorSubject(!1),this.loggedIn=this.loggedInSource.asObservable(),this.tokenKey="auth_jwt",this.checkLoggedIn()}return t.prototype.addAuthenticationToken=function(t){var e=this.getToken();return!e||t.url.includes("token")?t:t.clone({setHeaders:{Authorization:"Bearer "+e}})},t.prototype.checkLoggedIn=function(){return this.getToken()?this.loggedInSource.next(!0):this.loggedInSource.next(!1),this.loggedIn},t.prototype.getToken=function(){return this.storageService.get(this.tokenKey,"local")},t.prototype.login=function(t){var e=this;return this.http.post(this.configuration.tokenUrl,t).pipe(n.tap((function(t){e.storageService.set(e.tokenKey,t.token,"local"),e.loggedInSource.next(!0)})))},t.prototype.logout=function(){(this.storageService.delete(this.tokenKey,"local"),this.loggedInSource.next(!1),this.configuration.nosessionUrl)&&this.injector.get(c.Router).navigateByUrl(this.configuration.nosessionUrl)},t.ctorParameters=function(){return[{type:r.HttpClient},{type:i.StorageService},{type:void 0,decorators:[{type:e.Inject,args:["FactorAuthConfiguration"]}]},{type:e.Injector}]},t.ɵprov=e["ɵɵdefineInjectable"]({factory:function(){return new t(e["ɵɵinject"](r.HttpClient),e["ɵɵinject"](i.StorageService),e["ɵɵinject"]("FactorAuthConfiguration"),e["ɵɵinject"](e.INJECTOR))},token:t,providedIn:"root"}),t=u([e.Injectable({providedIn:"root"}),a(2,e.Inject("FactorAuthConfiguration"))],t)}(),h=function(){function t(t,e,r,n){this.http=t,this.storageService=e,this.configuration=r,this.injector=n,this.loggedInSource=new o.BehaviorSubject(!1),this.loggedIn=this.loggedInSource.asObservable(),this.refreshTokenInProgress=!1,this.refreshTokenSubject=new o.BehaviorSubject(null),this.checkLoggedIn()}return t.prototype.addAuthenticationToken=function(t){var e=this.getToken();return!e||t.url.includes("token")?t:t.clone({setHeaders:{Authorization:e.token_type+" "+e.access_token}})},t.prototype.checkLoggedIn=function(){return this.getToken()?this.loggedInSource.next(!0):this.loggedInSource.next(!1),this.loggedIn},t.prototype.getToken=function(){return this.storageService.get("token","local")},t.prototype.handle401Error=function(t,e){var r=this;return this.refreshTokenInProgress?this.refreshTokenSubject.pipe(n.filter((function(t){return null!=t})),n.take(1),n.switchMap((function(o){return e.handle(r.addAuthenticationToken(t))}))):(this.refreshTokenInProgress=!0,this.refreshTokenSubject.next(null),this.refreshToken().pipe(n.switchMap((function(n){return n?(r.refreshTokenSubject.next(n),e.handle(r.addAuthenticationToken(t))):(r.logout(),o.throwError(""))})),n.catchError((function(t){return r.logout(),o.throwError(t)})),n.share(),n.finalize((function(){r.refreshTokenInProgress=!1}))))},t.prototype.login=function(t){var e=this,r={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"password",response_type:"token",username:t.username,password:t.password,state:Date.now()};return this.http.post(this.configuration.tokenUrl,r).pipe(n.tap((function(t){e.storageService.set("token",t,"local"),e.loggedInSource.next(!0)})))},t.prototype.logout=function(){(this.storageService.delete("token","local"),this.loggedInSource.next(!1),this.configuration.nosessionUrl)&&this.injector.get(c.Router).navigateByUrl(this.configuration.nosessionUrl)},t.prototype.refreshToken=function(){var t=this,e=this.getToken(),r=""+this.configuration.tokenUrl,o={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"refresh_token",refresh_token:e.refresh_token};return this.http.get(r,{params:o}).pipe(n.tap((function(e){t.storageService.set("token",e,"local"),t.loggedInSource.next(!0)})))},t.ctorParameters=function(){return[{type:r.HttpClient},{type:i.StorageService},{type:void 0,decorators:[{type:e.Inject,args:["FactorAuthConfiguration"]}]},{type:e.Injector}]},t.ɵprov=e["ɵɵdefineInjectable"]({factory:function(){return new t(e["ɵɵinject"](r.HttpClient),e["ɵɵinject"](i.StorageService),e["ɵɵinject"]("FactorAuthConfiguration"),e["ɵɵinject"](e.INJECTOR))},token:t,providedIn:"root"}),t=u([e.Injectable({providedIn:"root"}),a(2,e.Inject("FactorAuthConfiguration"))],t)}(),g=function(){function t(t,e,r,o,n){this.http=t,this.storageService=e,this.jwtService=r,this.oauthService=o,this.configuration=n,this.getProvider().checkLoggedIn()}return t.prototype.getProvider=function(){return"oauth"===this.configuration.type?this.oauthService:this.jwtService},t.ctorParameters=function(){return[{type:r.HttpClient},{type:i.StorageService},{type:s},{type:h},{type:void 0,decorators:[{type:e.Inject,args:["FactorAuthConfiguration"]}]}]},t.ɵprov=e["ɵɵdefineInjectable"]({factory:function(){return new t(e["ɵɵinject"](r.HttpClient),e["ɵɵinject"](i.StorageService),e["ɵɵinject"](s),e["ɵɵinject"](h),e["ɵɵinject"]("FactorAuthConfiguration"))},token:t,providedIn:"root"}),t=u([e.Injectable({providedIn:"root"}),a(4,e.Inject("FactorAuthConfiguration"))],t)}(),f=function(){function t(t,e){this.injector=t,this.configuration=e,this.refreshTokenInProgress=!1,this.refreshTokenSubject=new o.BehaviorSubject(null)}return t.prototype.intercept=function(t,e){var i=this;return this.authService=this.injector.get(g),e.handle(this.authService.getProvider().addAuthenticationToken(t)).pipe(n.catchError((function(n){if(!(n instanceof r.HttpErrorResponse))return o.throwError(n);switch(n.status){case 401:return"undefined"!==i.authService.getProvider().handle401Error?i.authService.getProvider().handle401Error(t,e):(i.authService.getProvider().logout(),o.throwError(n));default:return o.throwError(n)}})))},t.ctorParameters=function(){return[{type:e.Injector},{type:void 0,decorators:[{type:e.Inject,args:["FactorAuthConfiguration"]}]}]},t=u([e.Injectable(),a(1,e.Inject("FactorAuthConfiguration"))],t)}(),p=function(){function t(){}var o;return o=t,t.forRoot=function(t){return{ngModule:o,providers:[{provide:r.HTTP_INTERCEPTORS,useClass:f,multi:!0},{provide:"FactorAuthConfiguration",useValue:t}]}},t=o=u([e.NgModule({declarations:[],imports:[],exports:[]})],t)}(),l=function(){function t(t,e){this.authService=t,this.configuration=e}return t.prototype.canActivate=function(t,e){return!!this.authService.getProvider().getToken()||(this.authService.getProvider().logout(),!1)},t.ctorParameters=function(){return[{type:g},{type:void 0,decorators:[{type:e.Inject,args:["FactorAuthConfiguration"]}]}]},t.ɵprov=e["ɵɵdefineInjectable"]({factory:function(){return new t(e["ɵɵinject"](g),e["ɵɵinject"]("FactorAuthConfiguration"))},token:t,providedIn:"root"}),t=u([e.Injectable({providedIn:"root"}),a(1,e.Inject("FactorAuthConfiguration"))],t)}(),d=function(){function t(t,e,r){this.authService=t,this.router=e,this.configuration=r}return t.prototype.canActivate=function(t,e){return!this.authService.getProvider().getToken()||(this.router.navigateByUrl("/"),!1)},t.ctorParameters=function(){return[{type:g},{type:c.Router},{type:void 0,decorators:[{type:e.Inject,args:["FactorAuthConfiguration"]}]}]},t.ɵprov=e["ɵɵdefineInjectable"]({factory:function(){return new t(e["ɵɵinject"](g),e["ɵɵinject"](c.Router),e["ɵɵinject"]("FactorAuthConfiguration"))},token:t,providedIn:"root"}),t=u([e.Injectable({providedIn:"root"}),a(2,e.Inject("FactorAuthConfiguration"))],t)}();t.AuthGuard=l,t.AuthModule=p,t.AuthService=g,t.LoginGuard=d,t.ɵa=f,t.ɵb=s,t.ɵc=h,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=factor-auth.umd.min.js.map