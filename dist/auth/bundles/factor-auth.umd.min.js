!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("factor-utils"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("@angular/core"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("factor-auth",["exports","factor-utils","@angular/router","rxjs","rxjs/operators","@angular/core","@angular/common/http"],t):t(e["factor-auth"]={},e.i2,e.ng.router,e.rxjs,e.rxjs.operators,e.ng.core,e.ng.common.http)}(this,function(e,t,n,i,c,r,u){"use strict";var a=function(){function e(e,t,r,o){this.http=e,this.injector=t,this.storageService=r,this.configuration=o,this.loggedInSource=new i.BehaviorSubject(!1),this.loggedIn$=this.loggedInSource.asObservable()}return e.prototype.login=function(e,t){var r=this;this.router=this.router||this.injector.get(n.Router);var o={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"password",response_type:"token",username:e.username,password:e.password};return this.http.post(this.configuration.tokenUrl,o).pipe(c.tap(function(e){r.storageService.set("token",e,localStorage),r.loggedInSource.next(!0),t&&r.router.navigate([t])}))},e.prototype.logout=function(e){this.router=this.router||this.injector.get(n.Router),this.storageService["delete"]("token",localStorage),this.loggedInSource.next(!1),this.router.navigate(["/login",e?{redirect:e}:{}])},e.prototype.getToken=function(){return this.storageService.get("token",localStorage)},e.prototype.refreshToken=function(){var t=this,e=this.storageService.get("token",localStorage),r=""+this.configuration.tokenUrl,o={client_id:this.configuration.clientId,client_secret:this.configuration.clientSecret,grant_type:"refresh_token",refresh_token:e.refresh_token};return this.http.get(r,{params:o}).pipe(c.tap(function(e){t.storageService.set("token",e,localStorage)}))},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:u.HttpClient},{type:r.Injector},{type:t.StorageService},{type:undefined,decorators:[{type:r.Inject,args:["FactorAuthConfiguration"]}]}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(u.HttpClient),r.inject(r.INJECTOR),r.inject(t.StorageService),r.inject("FactorAuthConfiguration"))},token:e,providedIn:"root"}),e}(),o=function(){function e(e){this.authService=e}return e.prototype.canActivate=function(e,t){return!!this.authService.getToken()||(this.authService.logout(t.url),!1)},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:a}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(a))},token:e,providedIn:"root"}),e}(),s=function(){function e(e,t){this.authService=e,this.router=t}return e.prototype.canActivate=function(e,t){return!this.authService.getToken()||(this.router.navigateByUrl("/"),!1)},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:a},{type:n.Router}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(a),r.inject(n.Router))},token:e,providedIn:"root"}),e}(),h=function(){function e(e){this.injector=e,this.refreshTokenInProgress=!1,this.refreshTokenSubject=new i.BehaviorSubject(null)}return e.prototype.intercept=function(t,r){var o=this;return this.authService=this.injector.get(a),r.handle(this.addAuthenticationToken(t)).pipe(c.catchError(function(e){if(!(e instanceof u.HttpErrorResponse))return i.throwError(e);switch(e.status){case 401:return o.handle401Error(t,r);default:return i.throwError(e)}}))},e.prototype.handle401Error=function(t,r){var o=this;return this.refreshTokenInProgress?this.refreshTokenSubject.pipe(c.filter(function(e){return null!=e}),c.take(1),c.switchMap(function(e){return r.handle(o.addAuthenticationToken(t))})):(this.refreshTokenInProgress=!0,this.refreshTokenSubject.next(null),this.authService.refreshToken().pipe(c.switchMap(function(e){return e?(o.refreshTokenSubject.next(e),r.handle(o.addAuthenticationToken(t))):(o.authService.logout(),i.throwError(""))}),c.catchError(function(e){return o.authService.logout(),i.throwError(e)}),c.share(),c.finalize(function(){o.refreshTokenInProgress=!1})))},e.prototype.addAuthenticationToken=function(e){var t=this.authService.getToken();return!t||e.url.includes("token")?e:e.clone({setHeaders:{Authorization:t.token_type+" "+t.access_token}})},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.Injector}]},e}(),f=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[{provide:u.HTTP_INTERCEPTORS,useClass:h,multi:!0},{provide:"FactorAuthConfiguration",useValue:e}]}},t.decorators=[{type:r.NgModule,args:[{declarations:[],imports:[],exports:[]}]}],t}();e.AuthService=a,e.AuthGuard=o,e.LoginGuard=s,e.AuthInterceptor=h,e.AuthModule=f,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=factor-auth.umd.min.js.map